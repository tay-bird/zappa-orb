description: >
  Update an existing Zappa stage or deploy a new one.

parameters:
  stage:
    type: string
    default: "dev"
    description: >
      The name of the Zappa stage to update or deploy to.

steps:
  - run:
      name: Deploying to << parameters.stage >>
      command: |-
        set +e
        STATUS=$(pipenv run zappa status << parameters.stage >> -j 2>&1)
        set -e
        if [[ $(echo $STATUS | jq . 2>/dev/null) ]];
        then pipenv run zappa update << parameters.stage >>;
        elif [[ "$STATUS" == *"have you deployed yet?" ]];
        then pipenv run zappa deploy << parameters.stage >>;
        else echo "$STATUS\nUnknown error!" && exit 1
        fi
